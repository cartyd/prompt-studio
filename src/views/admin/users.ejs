<% const title = 'User Management'; %>
<%- include('../layout-wrapper', { body: `
<link rel="stylesheet" href="/css/admin.css">
<link rel="stylesheet" href="/css/users.css">

<!-- Admin Header -->
<div class="admin-header">
  <div class="admin-header-container">
    <h1>User Management</h1>
    <div class="quick-actions">
      <a href="/admin/dashboard" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
  </div>
</div>

<!-- Control Bar -->
<div class="users-control-bar">
  <div class="left-controls">
    <div class="search-wrapper">
      <i class="fas fa-search"></i>
      <input type="text" class="user-search" placeholder="Search user..." id="user-search">
    </div>
  </div>
  <div class="right-controls">
    <!-- Filter Dropdown -->
    <div class="filter-dropdown">
      <button class="filter-btn" id="filter-btn">
        Filter: All Users <i class="fas fa-caret-down"></i>
      </button>
      <div class="filter-menu" id="filter-menu" hidden>
        <div class="filter-item" data-value="">All Users</div>
        <div class="filter-item" data-value="admin">Admin</div>
        <div class="filter-item" data-value="premium">Premium</div>
        <div class="filter-item" data-value="free">Free</div>
      </div>
    </div>
  </div>
</div>

<!-- Users Table -->
<table class="users-table">
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Subscription</th>
      <th>Prompts</th>
      <th>Events</th>
      <th>Joined</th>
      <th>Last Login</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="users-table-body">
    ${users.map(u => `
      <tr data-user-type="${u.isAdmin ? 'admin' : u.subscriptionTier}">
        <td>
          ${u.name}
          ${u.isAdmin ? '<span class="badge badge-admin ml-sm">Admin</span>' : ''}
        </td>
        <td>${u.email}</td>
        <td>
          ${u.subscriptionTier === 'premium' 
            ? '<span class="badge badge-premium">Premium</span>' 
            : 'Free'}
        </td>
        <td>${u._count.prompts}</td>
        <td>${u._count.events}</td>
        <td><span data-format-date="${u.createdAt}" data-format="date">${u.createdAt}</span></td>
        <td>
          ${u.lastLoginAt 
            ? `<span data-format-date="${u.lastLoginAt}" data-format="datetime">${u.lastLoginAt}</span>` 
            : '<span style="color: #999;">Never</span>'}
        </td>
        <td>
          <div class="action-dropdown">
            <button class="action-btn">
              Actions <i class="fas fa-caret-down"></i>
            </button>
            <div class="action-menu" hidden>
              <form action="/admin/users/${u.id}/toggle-premium" method="POST">
                <input type="hidden" name="_csrf" value="${csrfToken}">
                <button type="submit" class="action-item">
                  ${u.subscriptionTier === 'premium' ? 'Remove' : 'Make'} Premium
                </button>
              </form>
              <form action="/admin/users/${u.id}/toggle-admin" method="POST">
                <input type="hidden" name="_csrf" value="${csrfToken}">
                <button type="submit" class="action-item">
                  ${u.isAdmin ? 'Remove' : 'Make'} Admin
                </button>
              </form>
            </div>
          </div>
        </td>
      </tr>
    `).join('')}
  </tbody>
</table>

<!-- Pagination -->
<div class="pagination-wrapper">
  <div class="pagination-left" id="pagination-info">
    Total users: ${pagination.totalUsers}
  </div>
  <div class="pagination modern">
    ${pagination.currentPage > 1 
      ? `<a href="/admin/users?page=${pagination.currentPage - 1}" class="pag-btn">←</a>`
      : '<span class="pag-btn disabled">←</span>'}
    
    ${Array.from({length: Math.min(5, pagination.totalPages)}, (_, i) => {
      const pageNum = i + 1;
      const isActive = pageNum === pagination.currentPage;
      return isActive 
        ? `<span class="page-number active">${pageNum}</span>`
        : `<a href="/admin/users?page=${pageNum}" class="page-number">${pageNum}</a>`;
    }).join('')}
    
    ${pagination.currentPage < pagination.totalPages 
      ? `<a href="/admin/users?page=${pagination.currentPage + 1}" class="pag-btn">→</a>`
      : '<span class="pag-btn disabled">→</span>'}
  </div>
  <div class="pagination-right">
    <span>Show per page:</span>
    <select class="page-size-select">
      <option value="10" selected>10</option>
      <option value="25">25</option>
      <option value="50">50</option>
    </select>
  </div>
</div>

<script src="/js/admin-users.js"></script>
`, user, subscription }) %>
